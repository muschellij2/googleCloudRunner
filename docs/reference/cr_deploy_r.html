<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Deploy an R script with an optional schedule — cr_deploy_r • googleCloudRunner</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Deploy an R script with an optional schedule — cr_deploy_r"><meta property="og:description" content="Will create a build to run an R script in Cloud Build with an optional schedule from Cloud Scheduler"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul></li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-google-analytics.html">Schedule Google Analytics User Deletion API</a>
    </li>
    <li>
      <a href="../articles/usecase-rmarkdown-cloudrun.html">On-demand parameterised R Markdown reports</a>
    </li>
  </ul></li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Deploy an R script with an optional schedule</h1>
    <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/HEAD/R/deploy.R" class="external-link"><code>R/deploy.R</code></a></small>
    <div class="hidden name"><code>cr_deploy_r.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Will create a build to run an R script in Cloud Build with an optional schedule from Cloud Scheduler</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">cr_deploy_r</span><span class="op">(</span>
  <span class="va">r</span>,
  schedule <span class="op">=</span> <span class="cn">NULL</span>,
  source <span class="op">=</span> <span class="cn">NULL</span>,
  run_name <span class="op">=</span> <span class="cn">NULL</span>,
  r_image <span class="op">=</span> <span class="st">"rocker/verse"</span>,
  pre_steps <span class="op">=</span> <span class="cn">NULL</span>,
  post_steps <span class="op">=</span> <span class="cn">NULL</span>,
  timeout <span class="op">=</span> <span class="fl">600L</span>,
  <span class="va">...</span>,
  schedule_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pubsub"</span>, <span class="st">"http"</span><span class="op">)</span>,
  schedule_pubsub <span class="op">=</span> <span class="cn">NULL</span>,
  email <span class="op">=</span> <span class="fu"><a href="cr_email_set.html">cr_email_get</a></span><span class="op">(</span><span class="op">)</span>,
  region <span class="op">=</span> <span class="fu"><a href="cr_region_set.html">cr_region_get</a></span><span class="op">(</span><span class="op">)</span>,
  projectId <span class="op">=</span> <span class="fu"><a href="cr_project_set.html">cr_project_get</a></span><span class="op">(</span><span class="op">)</span>,
  serviceAccount <span class="op">=</span> <span class="cn">NULL</span>,
  launch_browser <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>r</dt>
<dd><p>R code to run or a file containing R code ending with .R, or the gs:// location on Cloud Storage of the R file you want to run</p></dd>
<dt>schedule</dt>
<dd><p>A cron schedule e.g. <code>"15 5 * * *"</code></p></dd>
<dt>source</dt>
<dd><p>A <a href="Source.html">Source</a> object specifying the location of the source files to build, usually created by <a href="cr_build_source.html">cr_build_source</a></p></dd>
<dt>run_name</dt>
<dd><p>What name the R code will identify itself as.  If <code>NULL</code> one is autogenerated.</p></dd>
<dt>r_image</dt>
<dd><p>The R docker environment executing the R code</p></dd>
<dt>pre_steps</dt>
<dd><p>Other <a href="cr_buildstep.html">cr_buildstep</a> to run before the R code executes</p></dd>
<dt>post_steps</dt>
<dd><p>Other <a href="cr_buildstep.html">cr_buildstep</a> to run after the R code executes</p></dd>
<dt>timeout</dt>
<dd><p>Amount of time that this build should be allowed to run, to second</p></dd>
<dt>...</dt>
<dd><p>Arguments passed on to <code><a href="cr_buildstep_r.html">cr_buildstep_r</a></code></p><dl><dt><code>name</code></dt>
<dd><p>The docker image that will run the R code, usually from rocker-project.org</p></dd>

    <dt><code>r_source</code></dt>
<dd><p>Whether the R code will be from a runtime file within the source or at build time copying over from a local R file in your session</p></dd>

    <dt><code>escape_dollar</code></dt>
<dd><p>Default TRUE.  This will turn <code>$</code> into <code>$$</code> within the script to avoid them being recognised as Cloud Build variables.  Turn this off if you want that behaviour (e.g. <code>my_project="$PROJECT_ID"</code>)</p></dd>

    <dt><code>rscript_args</code></dt>
<dd><p>Optional arguments for the R script run by <code>Rscript</code>.</p></dd>

    <dt><code>r_cmd</code></dt>
<dd><p>should `Rscript` be run or `R`?</p></dd>

    <dt><code>prefix</code></dt>
<dd><p>prefixed to name - set to "" to suppress.  Will be suppressed if <code>name</code> starts with gcr.io or <code>*-docker.pkg.dev</code></p></dd>

  
</dl></dd>
<dt>schedule_type</dt>
<dd><p>If you have specified a schedule, this will select what strategy it will use to deploy it. See details</p></dd>
<dt>schedule_pubsub</dt>
<dd><p>If you have a custom pubsub message to send via an existing topic, use <a href="cr_schedule.html">cr_schedule_pubsub</a> to supply it here</p></dd>
<dt>email</dt>
<dd><p>The email that will authenticate the job set via <a href="cr_email_set.html">cr_email_set</a></p></dd>
<dt>region</dt>
<dd><p>The region usually set with <a href="cr_region_set.html">cr_region_set</a></p></dd>
<dt>projectId</dt>
<dd><p>ID of the project</p></dd>
<dt>serviceAccount</dt>
<dd><p>service account email to be used for the build</p></dd>
<dt>launch_browser</dt>
<dd><p>Whether to launch the logs URL in a browser once deployed</p></dd>
</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>If scheduling then a <a href="Job.html">Job</a>, if building immediately then a <a href="Build.html">Build</a></p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>The R script will execute within the root directory of whichever <a href="Source.html">Source</a> you supply, usually created via <a href="cr_build_source.html">cr_build_source</a> representing a Cloud Storage bucket or a GitHub repository that is copied across before code execution.  Bear in mind if the source changes then the code scheduled may need updating.</p>
<p>The <code>r_image</code> dictates what R libraries the R environment executing the code of <code>r</code> will have, via the underlying Docker container usually supplied by rocker-project.org.  If you want custom R libraries beyond the default, create a docker container with those R libraries installed (perhaps via <a href="cr_deploy_docker.html">cr_deploy_docker</a>)</p>
    </div>
    <div id="scheduling">
    <h2>Scheduling</h2>
    


<p>If <code>schedule=NULL</code> then the R script will be run immediately on Cloud Build via <a href="cr_build.html">cr_build</a>.</p>
<p>If <code>schedule</code> carries a cron job string (e.g. <code>"15 5 * * *"</code>) then the build will be scheduled via Cloud Scheduler</p>
<p>If <code>schedule_type="pubsub"</code> then you will need <code>googlePubsubR</code> installed and set-up and scheduling will involve:</p>
<ol><li><p>Creating a PubSub topic called <code>"{run_name}-topic"</code> or subscribing to the one you provided in <code>schedule_pubsub</code>.  It is assumed you have created the PubSub topic beforehand if you do supply your own.</p></li>
<li><p>Create a Build Trigger called <code>"{run_name}-trigger"</code> that will run when the PubSub topic is called</p></li>
<li><p>Create a Cloud Schedule called <code>"{run_name}-trigger"</code> that will send a pubsub message to the topic: either the default that contains just the name of the script, or the message you supplied in <code>schedule_pubsub</code>.</p></li>
</ol><p>Type "pubsub" is recommended for more complex R scripts as you will have more visibility for debugging schedules via inspecting the PubSub topic, build trigger and build logs, as well as enabling triggering the script from other PubSub topics and allowing to pass dynamic parameters into your schedule scripts via the PubSub message.</p>
<p>If <code>schedule_type="http"</code> then scheduling will involve:</p>
<ol><li><p>Create a Cloud Build API call with your build embedded within it via <a href="cr_schedule.html">cr_schedule_http</a></p></li>
<li><p>Schedule the HTTP call using the authentication email supplied in <code>email</code> or the default <a href="cr_email_set.html">cr_email_get</a></p></li>
</ol><p>This is the old default and is suitable for smaller R scripts or when you don't want to use the other  GCP services.  The authentication for the API call from Cloud Scheduler can cause opaque errors as it will give you invalid response codes whether its that or an error in your R script you wish to schedule.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>If you want to run R code upon certain events like GitHub pushes, look at <a href="cr_buildtrigger.html">cr_buildtrigger</a></p>
<p>Other Deployment functions: 
<code><a href="cr_deploy_docker_trigger.html">cr_deploy_docker_trigger</a>()</code>,
<code><a href="cr_deploy_docker.html">cr_deploy_docker</a>()</code>,
<code><a href="cr_deploy_packagetests.html">cr_deploy_packagetests</a>()</code>,
<code><a href="cr_deploy_pkgdown.html">cr_deploy_pkgdown</a>()</code>,
<code><a href="cr_deploy_run_website.html">cr_deploy_run_website</a>()</code>,
<code><a href="cr_deploy_run.html">cr_deploy_run</a>()</code></p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"></span>
<span class="r-in"><span class="va">r_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span class="r-in">  <span class="st">"list.files()"</span>,</span>
<span class="r-in">  <span class="st">"library(dplyr)"</span>,</span>
<span class="r-in">  <span class="st">"mtcars %&gt;% select(mpg)"</span>,</span>
<span class="r-in">  <span class="st">"sessionInfo()"</span></span>
<span class="r-in"><span class="op">)</span></span>
<span class="r-in"><span class="va">source</span> <span class="op">&lt;-</span> <span class="fu"><a href="cr_build_source.html">cr_build_source</a></span><span class="op">(</span><span class="fu"><a href="RepoSource.html">RepoSource</a></span><span class="op">(</span><span class="st">"googleCloudStorageR"</span>,</span>
<span class="r-in">  branchName <span class="op">=</span> <span class="st">"master"</span></span>
<span class="r-in"><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in"><span class="fu"><a href="cr_project_set.html">cr_project_set</a></span><span class="op">(</span><span class="st">"my-project"</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="cr_region_set.html">cr_region_set</a></span><span class="op">(</span><span class="st">"europe-west1"</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="cr_email_set.html">cr_email_set</a></span><span class="op">(</span><span class="st">"123456@projectid.iam.gserviceaccount.com"</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># check the script runs ok</span></span>
<span class="r-in"><span class="fu">cr_deploy_r</span><span class="op">(</span><span class="va">r_lines</span>, source <span class="op">=</span> <span class="va">source</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># schedule the script</span></span>
<span class="r-in"><span class="fu">cr_deploy_r</span><span class="op">(</span><span class="va">r_lines</span>, schedule <span class="op">=</span> <span class="st">"15 21 * * *"</span>, source <span class="op">=</span> <span class="va">source</span><span class="op">)</span></span>
<span class="r-in"><span class="op">}</span></span>
<span class="r-in"></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer></div>

  


  

  </body></html>

