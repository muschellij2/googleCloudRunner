<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Docker image of a package each commit • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Create Docker image of a package each commit">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-google-analytics.html">Schedule Google Analytics User Deletion API</a>
    </li>
    <li>
      <a href="../articles/usecase-rmarkdown-cloudrun.html">On-demand parameterised R Markdown reports</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Create Docker image of a package each
commit</h1>
            
            <h4 data-toc-skip class="date">2022-03-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/HEAD/vignettes/usecase-package-docker-build.Rmd" class="external-link"><code>vignettes/usecase-package-docker-build.Rmd</code></a></small>
      <div class="hidden name"><code>usecase-package-docker-build.Rmd</code></div>

    </div>

    
    
<p>If you just want a one-off Docker image, use
<code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> or make your own build via
<code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code></p>
<p><img src="gadget_docker.png"></p>
<p>If you want the Docker image to rebuild each git commit, then you
also need a build trigger. This can be enabled using
<code><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger()</a></code></p>
<p>The below example builds this package’s Dockerfile upon each commit,
for a Dockerfile located in the <code>cloud_build/</code> folder.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger</a></span><span class="op">(</span><span class="va">repo</span>, <span class="st">"test3"</span>, dir <span class="op">=</span> <span class="st">"cloud_build"</span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="kaniko-cache">Kaniko cache<a class="anchor" aria-label="anchor" href="#kaniko-cache"></a>
</h3>
<p>A common workflow is to make lots of repeat builds of Docker images
as you update the files and libraries within the Dockerfile. If this is
a heavy operation it can take 20mins+ to build the image.</p>
<p>If it is a long build, consider using the <a href="https://cloud.google.com/cloud-build/docs/kaniko-cache" class="external-link">kaniko
cache</a> option in your Docker builds. This caches each step of the
Dockerfile so only those that are new are built, and can considerably
speed up Docker build times.</p>
<p>To use, select the <code>kamiko_cache=TRUE</code> option in your
builds:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span><span class="op">(</span><span class="st">"my_folder"</span>, kaniko_cache<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="combining-buildsteps-with-other-builds">Combining buildsteps with other builds<a class="anchor" aria-label="anchor" href="#combining-buildsteps-with-other-builds"></a>
</h2>
<p>It may be you want the build to do other things after the Docker
image is built such as use that Docker image somewhere. You can extract
the buildsteps from deployed buildtriggers to combine them and avoid
having two builds.</p>
<p>For example, say you have deployed a Dockerfile trigger:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"your-github/your-repo"</span><span class="op">)</span>

<span class="co"># first time - by default will be called "docker-{image}"</span>
<span class="fu"><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger</a></span><span class="op">(</span><span class="va">repo</span>, image <span class="op">=</span> <span class="st">"my-build"</span><span class="op">)</span></code></pre></div>
<p>If you want to extract the docker buildsteps you can find it in
<code>dock_build$build$steps</code> below:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get the buildtrigger details</span>
<span class="va">dock_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_get.html">cr_buildtrigger_get</a></span><span class="op">(</span><span class="st">"docker-my-build"</span><span class="op">)</span>

<span class="co"># contains the buildsteps from the deployment</span>
<span class="va">dock_build</span><span class="op">$</span><span class="va">build</span><span class="op">$</span><span class="va">steps</span></code></pre></div>
<p>You can then combine those buildsteps in the usual way with other
buildsteps. The example below assumes you’ve made an R docker image with
some of your custom dependencies that you then want to immediately run
your R code within:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># uses the docker image previously created</span>
<span class="va">my_r_step</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span>
  r <span class="op">=</span> <span class="st">"my_r_code.R"</span>,
  name <span class="op">=</span> <span class="st">"docker-my-build"</span>
<span class="op">)</span>

<span class="co"># combine the buildsteps</span>
<span class="va">new_buildsteps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dock_build</span><span class="op">$</span><span class="va">build</span><span class="op">$</span><span class="va">steps</span>, <span class="va">my_r_step</span><span class="op">)</span>

<span class="co"># remake the build yaml</span>
<span class="va">yml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span><span class="va">new_buildsteps</span><span class="op">)</span></code></pre></div>
<p>You can then reconfigure the build trigger with your new build yaml.
The below writes the yaml to a file to be read by the build trigger:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># write it out to the git repo we are in</span>
<span class="fu"><a href="../reference/cr_build_write.html">cr_build_write</a></span><span class="op">(</span><span class="va">yml</span>, <span class="st">"new_buildsteps.yml"</span><span class="op">)</span>

<span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"your-github/your-repo"</span><span class="op">)</span>

<span class="co"># overwrite the deployed build trigger to read the yml</span>
<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span>
  <span class="st">"new_buildsteps.yml"</span>,
  name <span class="op">=</span> <span class="st">"docker-my-build"</span>,
  trigger <span class="op">=</span> <span class="va">repo</span>,
  overwrite <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
