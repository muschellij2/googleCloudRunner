<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>googleCloudRunner and git (GitHub, GitLab, BitBucket etc.) â€¢ googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="googleCloudRunner and git (GitHub, GitLab, BitBucket etc.)">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-google-analytics.html">Schedule Google Analytics User Deletion API</a>
    </li>
    <li>
      <a href="../articles/usecase-rmarkdown-cloudrun.html">On-demand parameterised R Markdown reports</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>googleCloudRunner and git (GitHub, GitLab,
BitBucket etc.)</h1>
            
            <h4 data-toc-skip class="date">2022-03-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/HEAD/vignettes/git.Rmd" class="external-link"><code>vignettes/git.Rmd</code></a></small>
      <div class="hidden name"><code>git.Rmd</code></div>

    </div>

    
    
<p>A lot of the features of Cloud Build rely on connection with git
workflows.</p>
<div class="section level2">
<h2 id="cloud-build">Cloud Build<a class="anchor" aria-label="anchor" href="#cloud-build"></a>
</h2>
<p>Cloud Build can use two different sources created via
<code><a href="../reference/cr_build_source.html">cr_build_source()</a></code> - <code><a href="../reference/RepoSource.html">RepoSource()</a></code> is from <a href="https://cloud.google.com/source-repositories" class="external-link">Google Cloud Source
Repostitories</a> - <code><a href="../reference/StorageSource.html">StorageSource()</a></code> is from <a href="https://cloud.google.com/storage" class="external-link">Google Cloud Storage</a>
buckets.</p>
<p><code><a href="../reference/RepoSource.html">RepoSource()</a></code> could be a mirror of your GitHub or other
git provider. If you are using a Build Trigger (next section) then the
source is automatically configured to be your trigger source.</p>
<p>Once your repo is mirrored it gives you a Cloud Repository name which
is of the form <code>github_username_repo</code> - this you can add to a
<code><a href="../reference/RepoSource.html">RepoSource()</a></code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># this repo mirrored on Google Source repos</span>
<span class="va">my_repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_source.html">cr_build_source</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/RepoSource.html">RepoSource</a></span><span class="op">(</span><span class="st">"github_markedmondson1234_googlecloudrunner"</span>,
             branchName<span class="op">=</span><span class="st">"master"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cloud-build-triggers">Cloud Build Triggers<a class="anchor" aria-label="anchor" href="#cloud-build-triggers"></a>
</h2>
<p>Cloud Build triggers let you automate builds based on git pushes or
pull requests via <code><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo()</a></code> -
<code>cr_buildtrigger_repo(type="github")</code> lets you link to push
and pull events on GitHub repositories you have given permission for GCP
to access via the <a href="https://github.com/marketplace/google-cloud-build" class="external-link">GitHub Cloud
Build app</a> - <code>cr_buildtrigger_repo(type="cloud_source")</code>
lets you link to push events to <a href="https://cloud.google.com/source-repositories" class="external-link">Google Cloud Source
Repostitories</a> - this can include a mirror of GitHub or other git
providers such as BitBucket</p>
<p>An example setting up <code><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo()</a></code> with GitHub
is shown below - this will trigger builds when you push to the master
branch:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cloudbuild</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"cloudbuild/cloudbuild.yaml"</span>,
                           package <span class="op">=</span> <span class="st">"googleCloudRunner"</span><span class="op">)</span>
<span class="va">bb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="va">cloudbuild</span>, projectId <span class="op">=</span> <span class="st">"test-project"</span><span class="op">)</span>

<span class="co"># setting up the trigger event </span>
<span class="va">github</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span>, branch <span class="op">=</span> <span class="st">"master"</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span><span class="va">bb</span>, name <span class="op">=</span> <span class="st">"trig1"</span>, trigger <span class="op">=</span> <span class="va">github</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="calling-git-within-buildsteps">Calling git within buildsteps<a class="anchor" aria-label="anchor" href="#calling-git-within-buildsteps"></a>
</h2>
<p>By default the above will act via cloning your repo at the start of
any build. You may want to use git further within your cloud build
steps, such as commiting the results of your build back to the
repository.</p>
<p>This can be done within your build by using
<code><a href="../reference/cr_buildstep_git.html">cr_buildstep_gitsetup()</a></code> and
<code><a href="../reference/cr_buildstep_git.html">cr_buildstep_git()</a></code>. If you are doing non-public operations
(such as committing and pushing) then you will need to set up GitHub
authorization for the build to do so - the easiest method is to use <a href="https://cloud.google.com/secret-manager" class="external-link">Google Secret Manager</a>
to save a ssh key for your git securely, and then accessible via
<code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code>. This can be set up once and then
used for any future builds you create.</p>
<div class="section level3">
<h3 id="using-google-secret-manager-to-manage-git-ssh-keys">Using Google Secret Manager to manage git ssh keys<a class="anchor" aria-label="anchor" href="#using-google-secret-manager-to-manage-git-ssh-keys"></a>
</h3>
<p>Cloud Build needs permission to commit to git, so the first step is
to create an ssh key secret that it will use to work on your behalf.</p>
<p>The guide is for GitHub, adapt it if you use another git
provider:</p>
<ol style="list-style-type: decimal">
<li>Create or use an SSH key for your git account. On GitHub use this
guide:
<code>https://help.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh</code>
</li>
<li>Add the <strong>public</strong> key (filename ending with
<code>.pub</code>) to GitHubâ€™s SSH keys</li>
<li>Upload the <strong>private</strong> key (filename not ending with
<code>.pub</code>) to Google Secret Manager -
<code>https://console.cloud.google.com/security/secret-manager</code>
and call it a name such as <code>github-ssh</code>
</li>
</ol>
<p><img src="secret-ui.png"></p>
<ol start="4" style="list-style-type: decimal">
<li>Ensure you have <code>Secret Manager Secret Accessor</code> <a href="https://console.cloud.google.com/iam-admin/iam" class="external-link">IAM role</a>
assigned to the cloudbuild service email
(<code>{project-number}@cloudbuild.gserviceaccount.com</code>)</li>
<li>Use in your buildsteps by calling and using the git secret:</li>
</ol>
<p>In general the secret can be downloaded via
<code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code> which takes two arguments - the name
of the secret and the location of where the decrypted file should be
within your workspace.</p>
<p><code><a href="../reference/cr_buildstep_git.html">cr_buildstep_gitsetup()</a></code> wraps
<code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code> when you supply it the Secret Manager
name:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># assumes you have previously saved git ssh key called "github-ssh"</span>
<span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
      steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
           <span class="fu"><a href="../reference/cr_buildstep_git.html">cr_buildstep_gitsetup</a></span><span class="op">(</span><span class="st">"github-ssh"</span><span class="op">)</span>,
           <span class="fu"><a href="../reference/cr_buildstep_git.html">cr_buildstep_git</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"clone"</span>,
                              <span class="st">"git@github.com:github_name/repo_name"</span><span class="op">)</span><span class="op">)</span>
      <span class="op">)</span>
  <span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="examples-of-git-workflows">Examples of Git workflows<a class="anchor" aria-label="anchor" href="#examples-of-git-workflows"></a>
</h2>
<p>A rundown on some common workflows and connections are detailed
here.</p>
<div class="section level3">
<h3 id="clone-your-repo-build-and-commit-back-to-same-repo">Clone your repo, build and commit back to same repo<a class="anchor" aria-label="anchor" href="#clone-your-repo-build-and-commit-back-to-same-repo"></a>
</h3>
<p>A common use case is creating a pkgdown website of your package. This
involves building the website upon each git commit, creating the new
pkgdown HTML then committing that back to the GitHub repo so it can
display the page using GitHub page hosting.</p>
<ol style="list-style-type: decimal">
<li>Connect your GitHub repo via the <a href="https://github.com/marketplace/google-cloud-build" class="external-link">GitHub Cloud
Build app</a>
</li>
<li>Setup a git ssh key in Secret Manager using the guide above</li>
<li>Use <code><a href="../reference/cr_deploy_pkgdown.html">cr_deploy_pkgdown()</a></code>:</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_pkgdown.html">cr_deploy_pkgdown</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span>, secret <span class="op">=</span> <span class="st">"my_git_secret"</span><span class="op">)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Commit your changes</li>
</ol>
<p>By default this will create a cloudbuild-pkgdown.yml file in your
repo that holds the buildsteps to build and commit your website, and
create the buildtrigger that will run this build upon each commit to the
master branch.</p>
</div>
<div class="section level3">
<h3 id="create-docker-image-of-repository-each-commit">Create Docker image of repository each commit<a class="anchor" aria-label="anchor" href="#create-docker-image-of-repository-each-commit"></a>
</h3>
<p>If you want the Docker image to rebuild each git commit, then you
also need a build trigger. This can be enabled using
<code><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger()</a></code></p>
<ol style="list-style-type: decimal">
<li>Create your Dockerfile and place it in your repo</li>
<li>Specify the repository the buidl will clone from each commit via
<code><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo()</a></code>
</li>
<li>Use <code><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger()</a></code> and point it at your
Dockerfile folder</li>
<li>Commit to the repository</li>
</ol>
<p>The <code><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger()</a></code> will create a
buildtrigger that will build the Dockerfile upon each commit.</p>
<p>The below example builds this packageâ€™s GitHub repo and its
Dockerfile upon each commit, for a Dockerfile located in the
<code>cloud_build/</code> folder.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger</a></span><span class="op">(</span><span class="va">repo</span>, <span class="st">"googleCloudRunner"</span>, dir <span class="op">=</span> <span class="st">"cloud_build"</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
