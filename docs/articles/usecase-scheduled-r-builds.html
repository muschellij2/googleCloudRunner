<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Run R code on a schedule • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Run R code on a schedule">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-google-analytics.html">Schedule Google Analytics User Deletion API</a>
    </li>
    <li>
      <a href="../articles/usecase-rmarkdown-cloudrun.html">On-demand parameterised R Markdown reports</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Run R code on a schedule</h1>
            
            <h4 data-toc-skip class="date">2022-03-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/HEAD/vignettes/usecase-scheduled-r-builds.Rmd" class="external-link"><code>vignettes/usecase-scheduled-r-builds.Rmd</code></a></small>
      <div class="hidden name"><code>usecase-scheduled-r-builds.Rmd</code></div>

    </div>

    
    
<p>Sometimes you just want to have some R code running whilst you get on
with something else. In this case you can use
<code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code> to run your R code even after you have
turned your computer off, since its running in the cloud. You can also
set it up on a schedule to run periodically.</p>
<p>When running R code, it needs to run in an environment that has the
packages and resources it needs. If those are covered by images such as
<code>rocker/verse</code> (the tidyverse) then you can commit it
straight away. Otherwise you can first make a custom Docker file with
the R packages you need in it, and then run your code against that.</p>
<p>Once you have your R code and chosen the Docker image, then you can
use <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code> to point at your R file and Docker image,
set the timeout to what you need (the maximum is 24 hours) and select a
schedule if you need it.</p>
<div class="section level2">
<h2 id="typical-workflow-for-running-r-on-cloud-build">Typical workflow for running R on Cloud Build<a class="anchor" aria-label="anchor" href="#typical-workflow-for-running-r-on-cloud-build"></a>
</h2>
<p>A typical workflow is:</p>
<ol style="list-style-type: decimal">
<li>Create your R script</li>
<li>Pick or build a Docker image running R that has the libraries
necessary for that script - for example <code>rocker/verse</code>. If
you need to build your own with a <code>Dockerfile</code> include that
in a step before your R code runs.</li>
<li>Use that Docker image to run your R script within with
<code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>
</li>
<li>Deploy the Build via <code><a href="../reference/cr_build.html">cr_build()</a></code>
</li>
<li>Optionally setup scheduling or a build trigger for when your R
script will fire in the future.</li>
</ol>
<p>An example of code doing the above would be:</p>
<div class="section level3">
<h3 id="using-a-precreated-docker-image">Using a precreated docker image<a class="anchor" aria-label="anchor" href="#using-a-precreated-docker-image"></a>
</h3>
<p>The below assumes your R script can run with
<code>rocker/verse</code></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_r_script</span> <span class="op">&lt;-</span> <span class="st">"here.R"</span>

<span class="va">bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span>
    <span class="va">my_r_script</span>,
    name <span class="op">=</span> <span class="st">"rocker/verse"</span>
  <span class="op">)</span>

<span class="co"># here you can add metadata for the build steps, such as timeout</span>
<span class="va">my_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span><span class="va">bs</span>, timeout <span class="op">=</span> <span class="fl">2400</span><span class="op">)</span>

<span class="co"># build it</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">my_build</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-an-r-docker-image-you-build-yourself">Using an R Docker image you build yourself<a class="anchor" aria-label="anchor" href="#using-an-r-docker-image-you-build-yourself"></a>
</h3>
<p>Here the Docker image is first built, then used in the R build
afterwards (in the <code>name</code> argument). It is also pushed to
Google Container Registry.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_r_script</span> <span class="op">&lt;-</span> <span class="st">"here.R"</span>
<span class="va">my_dockerfile_folder</span> <span class="op">&lt;-</span> <span class="st">"my_build/"</span>

<span class="co"># build your image called my-r-docker</span>
<span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span><span class="op">(</span><span class="va">my_dockerfile_folder</span>, 
                 image_name <span class="op">=</span> <span class="st">"gcr.io/$PROJECT_ID/my-r-docker"</span><span class="op">)</span>

<span class="co"># now the buildstep uses the built image</span>
<span class="va">bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span>
    <span class="va">my_r_script</span>,
    name <span class="op">=</span> <span class="st">"gcr.io/$PROJECT_ID/my-r-docker"</span><span class="op">)</span>

<span class="co"># here you can add metadata for the build steps, such as timeout</span>
<span class="va">my_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span><span class="va">bs</span>, timeout <span class="op">=</span> <span class="fl">2400</span><span class="op">)</span>

<span class="co"># build it</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">my_build</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="other-docker-options">Other Docker options<a class="anchor" aria-label="anchor" href="#other-docker-options"></a>
</h3>
<p>Variations include:</p>
<ul>
<li>Include the R script within the Docker container, so you just need
to run the Docker image to execute your script</li>
<li>Build the Docker image in the same Cloud Build as the R script
running, for which you will need a source for the Dockerfile such as a
trigger on GitHub via <code><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo()</a></code> or Cloud
Storage</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="the-rstudio-gadget">The RStudio gadget<a class="anchor" aria-label="anchor" href="#the-rstudio-gadget"></a>
</h2>
<p>An RStudio gadget is also available to help you deploy:</p>
<p><img src="gadget_r.png"></p>
<p>If you want help creating the Docker image, try <a href="https://o2r.info/containerit/" class="external-link"><code>containerit</code></a> to
generate your Dockerfile, then use <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> to
build it.</p>
<p>NOTE: You must name the docker file “Dockerfile” when you use the
<code>containerit::write()</code> function</p>
</div>
<div class="section level2">
<h2 id="execute-r-scripts-directly-from-cloud-storage">Execute R scripts directly from Cloud Storage<a class="anchor" aria-label="anchor" href="#execute-r-scripts-directly-from-cloud-storage"></a>
</h2>
<p>In some cases you may hit character limits of the cloudbuild file in
which case you will need to execute the R code from a file. The easiest
way to do this is to upload your R code to a Cloud Storage bucket and
then supply the <code>gs://</code> URI to
<code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>:</p>
<p>The below example uses a public bucket and R image, for your use case
you would change to your own private one that your Cloud Build service
email has access to:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">large_r_job</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span><span class="st">"gs://mark-edmondson-public-read/schedule.R"</span>, 
                   name <span class="op">=</span> <span class="st">"gcr.io/gcer-public/googleauthr-verse:latest"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">large_r_job</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="authentication-within-the-r-script-on-cloud-build">Authentication within the R script on Cloud Build<a class="anchor" aria-label="anchor" href="#authentication-within-the-r-script-on-cloud-build"></a>
</h2>
<p>The recommended way to use secrets in build is to use
<code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code>, and upload the sensitive
authentication file to <a href="https://cloud.google.com/secret-manager" class="external-link">Google Secret Manager</a>
before hand.</p>
<p>You can also authenticate without uploading any file, if you can use
the default service account. This is usually the case for cloud services
such as BigQuery.</p>
<p>The default metadata of the Cloud Build server is the same as
<code>googleComputeEngineR</code>, so you can use
<code>googleAuthR::gar_gce_auth("default", scopes = "https://www.googleapis.com/auth/cloud-platform")</code>.</p>
<p>You can also use the Cloud Build email (the one that looks like
<code>{project-number@cloudbuild.gserviceaccount.com}</code>) if its
given the right access in Cloud IAM, authentication in your R script
will look like
<code>googleAuthR::gar_gce_auth("{project-number@cloudbuild.gserviceaccount.com}", scopes = "https://www.googleapis.com/auth/cloud-platform")</code></p>
<p>This enables you in the R script to download files from Cloud
Storage, for example. A minimal example is shown below:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(googleCloudStorageR)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(googleAuthR)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">gar_gce_auth</span>(<span class="st">"default"</span>, <span class="at">scopes =</span> <span class="st">"https://www.googleapis.com/auth/cloud-platform"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="do">## or if using the build email..</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># gar_gce_auth("{project-number@cloudbuild.gserviceaccount.com}", </span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                scopes = "https://www.googleapis.com/auth/cloud-platform")</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">gcs_list_buckets</span>(<span class="st">"my_project"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>auth_file <span class="ot">&lt;-</span> <span class="fu">gcs_get_object</span>(<span class="st">"config.json"</span>, <span class="at">bucket =</span> <span class="st">"my-bucket"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>...do something with the config file...</span></code></pre></div>
<p>This would then be saved to an R script and deployed via the gadget
or:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span><span class="op">(</span><span class="st">"the_script.R"</span>, r_image <span class="op">=</span> <span class="st">"gcr.io/gcer-public/googleauthr-verse"</span><span class="op">)</span></code></pre></div>
<p>…where the docker R image is one with googleCloudStorageR
installed.</p>
</div>
<div class="section level2">
<h2 id="importing-data-for-your-r-script-to-operate-upon">Importing data for your R script to operate upon<a class="anchor" aria-label="anchor" href="#importing-data-for-your-r-script-to-operate-upon"></a>
</h2>
<p>There are lots of options for how your script will interact with
data:</p>
<ol style="list-style-type: decimal">
<li>Download the data from within the R script itself, perhaps with
<code>googleCloudStorageR</code> or similar</li>
<li>Have a previous buildstep download the data into the Cloud Build
workspace <code>/workspace/</code>, then have your R script import that
file. e.g. use <code><a href="../reference/cr_buildstep_gcloud.html">cr_buildstep_gcloud()</a></code> to download from Cloud
Storage before running <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>
</li>
<li>Use <code><a href="../reference/cr_buildstep_git.html">cr_buildstep_git()</a></code> to clone or pull from another
git repo</li>
<li>If using a <code><a href="../reference/RepoSource.html">RepoSource()</a></code> or a
<code><a href="../reference/StorageSource.html">StorageSource()</a></code> object in your Cloud Build, update those
sources from some other process that will be included in the next
build</li>
<li>If using Build Triggers, the git repo the trigger is based upon will
include the changes of the latest git commit</li>
<li>Include the data within the Docker container environment the R
script runs within</li>
</ol>
</div>
<div class="section level2">
<h2 id="build-an-rmd-on-a-schedule-and-host-its-html-on-cloud-storage">Build an Rmd on a schedule and host its HTML on Cloud Storage<a class="anchor" aria-label="anchor" href="#build-an-rmd-on-a-schedule-and-host-its-html-on-cloud-storage"></a>
</h2>
<p>Cloud Storage can host public HTML files like a website, which can be
accessed via public or private viewers. This can be useful in setting up
reporting infrastructure.</p>
<p>A video of the below workflow is <a href="https://www.youtube.com/watch?v=BainmerWVb0" class="external-link">here</a>:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/BainmerWVb0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>The Cloud Build below makes use of Cloud Build artifacts to send the
built Rmd files to a public Cloud Storage bucket. The Rmd is built on a
schedule to pull in new data from a Google Sheet:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rmd_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
      <span class="st">"gsutil"</span>,
      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cp"</span>,
               <span class="st">"gs://mark-edmondson-public-read/scheduled_rmarkdown.Rmd"</span>,
               <span class="st">"scheduled_rmarkdown.Rmd"</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span>
      <span class="st">"gcr.io/gcer-public/render_rmd:master"</span>,
      r <span class="op">=</span> <span class="st">"rmarkdown::render('scheduled_rmarkdown.Rmd',
               output_file = 'scheduled_rmarkdown_2020.html')"</span>,
  <span class="op">)</span><span class="op">)</span>,
  artifacts <span class="op">=</span> <span class="fu"><a href="../reference/cr_build_yaml_artifact.html">cr_build_yaml_artifact</a></span><span class="op">(</span>
    <span class="st">"scheduled_rmarkdown_2020.html"</span>,
    bucket <span class="op">=</span> <span class="st">"mark-edmondson-public-read"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># test the build</span>
<span class="va">built</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">rmd_build</span><span class="op">)</span></code></pre></div>
<p>Once the build is tested, we now schedule the Rmd to build each
morning, adapting to changes in the source data file.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># schedule the build</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"rmd-demo"</span>, schedule <span class="op">=</span> <span class="st">"15 5 * * *"</span>,
            httpTarget <span class="op">=</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_http</a></span><span class="op">(</span><span class="va">built</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The example Rmd file is built and available on a public Cloud Storage
bucket - the above example is available at this <a href="https://storage.googleapis.com/mark-edmondson-public-read/scheduled_rmarkdown.html" class="external-link">link</a></p>
<p><img src="schedule_markdown_hosted_gcs.png"></p>
</div>
<div class="section level2">
<h2 id="build-and-deploy-rmd-files-to-cloud-run-on-a-schedule">Build and deploy Rmd files to Cloud Run on a schedule<a class="anchor" aria-label="anchor" href="#build-and-deploy-rmd-files-to-cloud-run-on-a-schedule"></a>
</h2>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
I have a flexdashboard that shows data from a Google Sheet with
ggplotly. What's the best way to host the dashboard somewhere
<em>and</em> make it so it shows the latest data? i.e. how should I show
dynamic data in an RMarkdown dashboard? Continually reknit? Make a
plumber API?
<a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw" class="external-link">#rstats</a>
</p>
— Andrew Heiss, PhD (<span class="citation">@andrewheiss</span>)
<a href="https://twitter.com/andrewheiss/status/1212408575684943878?ref_src=twsrc%5Etfw" class="external-link">January
1, 2020</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Cloud Run scales from 0 to millions of hits, so can be an option for
hosting a website. In particular you may want a private internal
website, have R code executing via a plumber API in the same container,
or have lots of traffic or data that goes over other free hosting
options such as GitHub pages. A nginx server configuration is included
to host any HTML you provide via <code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code>.</p>
<p>You may prefer using Cloud Storage public URLs if you don’t need any
of Cloud Run’s features, like the previous example.</p>
<p>Coupled to that, a common use case is to render Rmd files and host
them on a website like the tweet above. For the above tweet scenario,
the Rmd has a setup block that reads from googlesheets via the code
below:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="in">library(flexdashboard)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="in">library(googlesheets4)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="in">library(plotly)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="in"># for public Googlesheets.  </span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="in"># If private see https://gargle.r-lib.org/articles/non-interactive-auth.html</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="in">sheets_deauth()</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="in"># this is the data that may update each time the Rmd is rendered</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="in">gm &lt;- sheets_example("gap") %&gt;% read_sheet()</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="in">gm_agg &lt;- gm %&gt;%</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(gdp=gdpPercap*pop) %&gt;%</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(continent=="Africa") %&gt;%</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(year) %&gt;%</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(mean(lifeExp), mean(gdp))</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="in">p &lt;- ggplot(gm, aes(gdpPercap, lifeExp)) + theme_minimal() + scale_x_log10()</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div>
<p>The build Rmd docker in this case needs all the libraries listed
(flexdashboard, googlesheets4 etc.) included in its build - this could
be built before hand in another Cloud Build - in this case the libraries
are all in <code>gcr.io/gcer-public/render_rmd</code></p>
<p>For this example, the build is not reading from a git repo but the
Rmd file is downloaded from a Cloud Storage bucket, that you may have
uploaded to manually, via <code>googleCloudStorageR</code> or perhaps
copied over from a repo in another Cloud Build on a Build Trigger.</p>
<p>The scheduled build then can be enabled via:</p>
<ol style="list-style-type: decimal">
<li>Uploading your Rmarkdown files to a Cloud Storage bucket</li>
<li>Create a build that will:</li>
</ol>
<ul>
<li>download the Rmd file</li>
<li>render the Rmd creating the HTML files</li>
<li>configure nginx for Cloud Run,</li>
<li>build a Docker image of nginx with your HTML</li>
<li>serve it on Cloud Run.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r</span> <span class="op">&lt;-</span> <span class="st">"rmarkdown::render('scheduled_rmarkdown.Rmd', output_file = 'scheduled_rmarkdown.html')"</span>

<span class="va">build_rmd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
      steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
        <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
          id <span class="op">=</span> <span class="st">"download Rmd template"</span>,
          name <span class="op">=</span> <span class="st">"gsutil"</span>,
          args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cp"</span>,
                   <span class="st">"gs://mark-edmondson-public-read/scheduled_rmarkdown.Rmd"</span>,
                   <span class="st">"scheduled_rmarkdown.Rmd"</span><span class="op">)</span>,
        <span class="op">)</span>,
        <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span>
          id<span class="op">=</span><span class="st">"render rmd"</span>,
          r <span class="op">=</span> <span class="va">r</span>,
          name <span class="op">=</span> <span class="st">"gcr.io/gcer-public/render_rmd:master"</span>
        <span class="op">)</span>,
        <span class="fu"><a href="../reference/cr_buildstep_nginx_setup.html">cr_buildstep_nginx_setup</a></span><span class="op">(</span><span class="st">"/workspace/"</span><span class="op">)</span>,
        <span class="fu"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span><span class="op">(</span><span class="st">"html-on-cloudrun"</span>, tag <span class="op">=</span> <span class="st">"$BUILD_ID"</span><span class="op">)</span>,
        <span class="fu"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"my-html-on-cloudrun"</span>,
                         image <span class="op">=</span> <span class="st">"gcr.io/mark-edmondson-gde/html-on-cloudrun:$BUILD_ID"</span>,
                         concurrency <span class="op">=</span> <span class="fl">80</span><span class="op">)</span>
        <span class="op">)</span>, 
    images <span class="op">=</span> <span class="st">"gcr.io/mark-edmondson-gde/html-on-cloudrun:$BUILD_ID"</span>,
    <span class="op">)</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Run a test build to check it works.</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">build_rmd</span><span class="op">)</span>
<span class="va">built</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></code></pre></div>
<p>You should see a Cloud Run URL in the logs, like this one:
<code>https://my-html-on-cloudrun-ewjogewawq-ew.a.run.app/scheduled_rmarkdown.html</code></p>
<p><img src="rmd-on-cloudrun.png"></p>
<ol start="6" style="list-style-type: decimal">
<li>Schedule the build using cron syntax</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_http</a></span><span class="op">(</span><span class="va">built</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"rmd-on-cloudrun"</span>, <span class="st">"15 8 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">schedule_me</span><span class="op">)</span>
<span class="co">#==CloudScheduleJob==</span>
<span class="co">#name:  projects/project-name/locations/europe-west1/jobs/rmd-on-cloudrun </span>
<span class="co">#state:  ENABLED </span>
<span class="co">#httpTarget.uri:  https://cloudbuild.googleapis.com/v1/projects/project-name/builds </span>
<span class="co">#httpTarget.httpMethod:  POST </span>
<span class="co">#userUpdateTime:  2020-01-04T08:34:42Z </span>
<span class="co">#schedule:  15 8 * * * </span>
<span class="co">#timezone:  UTC </span></code></pre></div>
<div class="section level3">
<h3 id="do-it-all-in-r-using-cr_deploy_r">Do it all in R using cr_deploy_r()<a class="anchor" aria-label="anchor" href="#do-it-all-in-r-using-cr_deploy_r"></a>
</h3>
<p>An alternative if you only wanted to do a scheduled deployment would
be to put all steps in an R script (downloading, building and uploading
to Cloud Storage via <code>googleCloudStorageR</code>) and use the
RStudio gadget or <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code></p>
<p><img src="gadget_r.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="migrate-an-existing-scheduled-docker-container">Migrate an existing scheduled Docker container<a class="anchor" aria-label="anchor" href="#migrate-an-existing-scheduled-docker-container"></a>
</h2>
<p>You may have an existing Docker container containing code, that
doesn’t need a public URL.</p>
<p>For example, a self-contained R script with
<code>googleAnalyticsR</code> and <code>bigQueryR</code> pre-installed,
that downloads data from Google Analytics and uploads it to BigQuery.
This may be running on a VM from <code>googleComputeEngineR</code>,
Kubernetes or Airflow KubernetesPodOperator.</p>
<p>If you give the cloud build service email the right permissions, then
this can all be done on Cloud Build + Cloud Scheduler.</p>
<p>For example, say your existing container is called
<code>gcr.io/my-project/my-r-script</code>. A Cloud Build could look
simply like this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span><span class="st">"gcr.io/my-project/my-r-script"</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">r_code</span><span class="op">)</span></code></pre></div>
<p>You could add other steps if you wanted, such as sending an email
when done via <code><a href="../reference/cr_buildstep_mailgun.html">cr_buildstep_mailgun()</a></code> or
<code><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span><span class="st">"gcr.io/my-project/my-r-script"</span><span class="op">)</span>,
            <span class="fu"><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack</a></span><span class="op">(</span><span class="st">"The script run ok"</span><span class="op">)</span><span class="op">)</span>,
  substitutions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`_SLACK_WEBHOOK` <span class="op">=</span> <span class="st">"https://your_slack_webhook"</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">r_code</span><span class="op">)</span></code></pre></div>
<p>To set this up in a schedule, add it to the scheduler like so:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_http</a></span><span class="op">(</span><span class="va">r_code</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"r-code-example"</span>, <span class="st">"15 8 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">schedule_me</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-r-code-via-cloud-run">Run R code via Cloud Run<a class="anchor" aria-label="anchor" href="#run-r-code-via-cloud-run"></a>
</h2>
<p>Instead of using Cloud Build, you may want to use Cloud Run as the
engine running the R code, either because you want to control the code
via parametisation of a HTTP request to your R code, or one use case I
came across was needing to make requests from a fixed ip address - Cloud
Run offers a way to fix the IP of the app.</p>
<p>See the <a href="https://code.markedmondson.me/googleCloudRunner/articles/usecase-r-api-microservices.html">R
API Microservices Use Case</a> for more details on creating and
deploying an R API using plumber.</p>
<p>R code is triggered using an API package such as plumber to create
HTTP endpoints. The scheduler can then use that HTTP endpoint as the
mechanism to trigger schedules.</p>
<p>See <code><a href="../reference/cr_run_schedule_http.html">?cr_run_schedule_http</a></code> for examples.</p>
<div class="section level3">
<h3 id="public-apis">Public APIs<a class="anchor" aria-label="anchor" href="#public-apis"></a>
</h3>
<p>For R code that is public you don’t need to worry about
authentication, so you can trigger your R code by creating a
<code><a href="../reference/HttpTarget.html">?HttpTarget</a></code> object that will carry your endpoint and
parameters as set up in your plumber app:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for unauthenticated apps create a HttpTarget</span>
<span class="va">run_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/HttpTarget.html">HttpTarget</a></span><span class="op">(</span>
  uri <span class="op">=</span> <span class="st">"https://public-ewjogewawq-ew.a.run.app/echo?msg=blah"</span>,
  http_method <span class="op">=</span> <span class="st">"GET"</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"cloudrun-scheduled"</span>, schedule <span class="op">=</span> <span class="st">"16 4 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">run_me</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="private-apis">Private APIs<a class="anchor" aria-label="anchor" href="#private-apis"></a>
</h3>
<p>For private R APIs, you can use <code><a href="../reference/cr_jwt_create.html">cr_jwt_create()</a></code> and
friends to call the API from your local R session, but for Cloud
Scheduler to call the API a special new service account is needed with
Cloud Run Invoker authentication rights.</p>
<p>When you create an app via
<code>cr_deploy_run("my-app", allowUnauthenticated = TRUE)</code> a new
service account will be created with the rights called “my-app-invoker”.
Use that email to tell the scheduler how to call the app:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for authenticated Cloud Run apps - create with allowUnauthenticated=FALSE</span>
<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_run</a></span><span class="op">(</span><span class="st">"my-app"</span>, allowUnauthenticated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># deploying via R will help create a service email called my-app-invoker</span>
<span class="fu"><a href="../reference/cr_run_email.html">cr_run_email</a></span><span class="op">(</span><span class="st">"my-app"</span><span class="op">)</span>
<span class="co">#&gt; "my-app-invoker@your-project.iam.gserviceaccount.com"</span>

<span class="co"># schedule the endpoint</span>
<span class="va">my_app</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_get.html">cr_run_get</a></span><span class="op">(</span><span class="st">"my-app"</span><span class="op">)</span>

<span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_app</span><span class="op">$</span><span class="va">status</span><span class="op">$</span><span class="va">url</span>, <span class="st">"/fetch_stuff"</span><span class="op">)</span>

<span class="va">app_sched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_schedule_http.html">cr_run_schedule_http</a></span><span class="op">(</span><span class="va">endpoint</span>,
                                  http_method <span class="op">=</span> <span class="st">"GET"</span>,
                                  email <span class="op">=</span> <span class="fu"><a href="../reference/cr_run_email.html">cr_run_email</a></span><span class="op">(</span><span class="st">"my-app"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"my-app-scheduled-1"</span>,
            schedule <span class="op">=</span> <span class="st">"16 4 * * *"</span>,
            httpTarget <span class="op">=</span> <span class="va">app_sched</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
