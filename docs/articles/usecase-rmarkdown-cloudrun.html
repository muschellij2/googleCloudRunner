<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parameterised RMarkdown URLs on Cloud Run â€¢ googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parameterised RMarkdown URLs on Cloud Run">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-google-analytics.html">Schedule Google Analytics User Deletion API</a>
    </li>
    <li>
      <a href="../articles/usecase-rmarkdown-cloudrun.html">On-demand parameterised R Markdown reports</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parameterised RMarkdown URLs on Cloud Run</h1>
            
            <h4 data-toc-skip class="date">2022-03-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/HEAD/vignettes/usecase-rmarkdown-cloudrun.Rmd" class="external-link"><code>vignettes/usecase-rmarkdown-cloudrun.Rmd</code></a></small>
      <div class="hidden name"><code>usecase-rmarkdown-cloudrun.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="serverless-on-demand-parameterised-r-markdown-reports-with-google-cloud-run">Serverless, on-demand parameterised R Markdown reports with Google
Cloud Run<a class="anchor" aria-label="anchor" href="#serverless-on-demand-parameterised-r-markdown-reports-with-google-cloud-run"></a>
</h2>
<p>This use case is inspired by <a href="https://mdneuzerling.com/post/serverless-on-demand-parametrised-r-markdown-reports-with-aws-lambda/" class="external-link">this
post by David Neuzerling</a> who showed how it can be done
<code><a href="https://lambdr.mdneuzerling.com/" class="external-link">library(lambdr)</a></code>, which is a serverless HTML service similar
to Cloud Run but on AWS.</p>
<p>In this use case we would like an Rmd file to be rendered each time
it is requested by HTTP requests. This is opposed to scheduled renders
which can host the HTML on Cloud Storage or use Cloud Run as a nginx
server to host that HTML (detailed in this use case: <a href="https://code.markedmondson.me/googleCloudRunner/articles/usecase-scheduled-r-builds.html#build-an-rmd-on-a-schedule-and-host-its-html-on-cloud-storage-1">Build
an Rmd on a schedule and host its HTML</a>)</p>
<p>Since the HTTP request will be executing code each time this is more
expensive in compute cost and also bear in mind that although Cloud Run
has execution times of up to 60mins the web browsers requesting the page
will timeout in at most a minute, so the Rmd you use should not have
expensive computations. If you do, schedule a build of the HTML
instead.</p>
<p>You can see an example of the below running at
<code>https://cloudrun-rmarkdown-ewjogewawq-ew.a.run.app/</code> which
you can also deploy yourself via the following code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">deploy_folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"cloudrun_rmarkdown"</span>, package <span class="op">=</span> <span class="st">"googleCloudRunner"</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span><span class="op">(</span><span class="va">deploy_folder</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="strategy">Strategy<a class="anchor" aria-label="anchor" href="#strategy"></a>
</h2>
<p>To enable this use case we will need:</p>
<ul>
<li>A plumber API to receive the HTTP request, render the Rmd and serve
up the result</li>
<li>An R Markdown (Rmd) to render into HTML</li>
<li>A Docker file containing plumber, rmarkdown, any libraries you need
for your Rmd to run, plus any system depdencies.</li>
</ul>
<div class="section level3">
<h3 id="plumber-api">plumber API<a class="anchor" aria-label="anchor" href="#plumber-api"></a>
</h3>
<p>The plumber API needs to only render the Rmarkdown. I also include a
separate server.R file for launching plumber in Cloud Run in the
container.</p>
<p>The <code>api.R</code> receives the parameter in the URL and passes
it into the <code>rmarkdown</code> render, outputting the HTML.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Plot out data from the mtcars</span>
<span class="co">#' @param cyl If provided, passed into Rmd rendering parameters</span>
<span class="co">#' @get /</span>
<span class="co">#' @serializer html</span>
<span class="kw">function</span><span class="op">(</span><span class="va">cyl</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>

  <span class="co"># to avoid caching a timestamp is added</span>
  <span class="va">outfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"mtcars-%s.html"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"[^0-9]"</span>,<span class="st">""</span>,<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># render markdown to the file</span>
  <span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/render.html" class="external-link">render</a></span><span class="op">(</span>
    <span class="st">"mtcars.Rmd"</span>,
    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="va">cyl</span><span class="op">)</span>,
    envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span>,
    output_file <span class="op">=</span> <span class="va">outfile</span>
  <span class="op">)</span>

  <span class="co"># read html of file back in and use as response for plumber</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readChar.html" class="external-link">readChar</a></span><span class="op">(</span><span class="va">outfile</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="va">outfile</span><span class="op">)</span><span class="op">$</span><span class="va">size</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The <code>server.R</code> is generic boilerplate that launches the
plumber API within the Cloud Run container</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu">plumber</span><span class="fu">::</span><span class="fu"><a href="https://www.rplumber.io/reference/plumb.html" class="external-link">plumb</a></span><span class="op">(</span><span class="st">"api.R"</span><span class="op">)</span>
<span class="va">pr</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>host<span class="op">=</span><span class="st">'0.0.0.0'</span>, port<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">'PORT'</span><span class="op">)</span><span class="op">)</span>, swagger<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="r-markdown">R Markdown<a class="anchor" aria-label="anchor" href="#r-markdown"></a>
</h3>
<p>Key parts from the example R Markdown is shown below. It is expected
you modify this to something more exciting:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Parameterised Cars on Cloud Run"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Mark Edmondson"</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "11/26/2021"</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> html_document</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="an">params:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">  cyl: 6</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span></code></pre></div>
<p>The above sets up the parameter you will use later in the document
via <code>params$cyl</code> - see below for its use in an R chunk within
the RMarkdown document:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># parameters are blank on first load</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">the_data</span> <span class="op">&lt;-</span> <span class="va">mtcars</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">the_data</span> <span class="op">&lt;-</span> <span class="va">mtcars</span><span class="op">[</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span> <span class="op">==</span> <span class="va">params</span><span class="op">$</span><span class="va">cyl</span>, <span class="op">]</span>
<span class="op">}</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">the_data</span><span class="op">)</span></code></pre></div>
<p>See the actual website which is rendered with the code for the full
version.</p>
</div>
<div class="section level3">
<h3 id="docker-file">Docker file<a class="anchor" aria-label="anchor" href="#docker-file"></a>
</h3>
<p>The Dockerfile needs the libraries plumber, rmarkdown plus anything
else you are using in your Rmd. I have an existing image with plumber
installed that I build from here. This is put in the same folder as the
plumber and Rmd scripts.</p>
<pre><code>FROM gcr.io/gcer-public/googlecloudrunner:master
RUN export DEBIAN_FRONTEND=noninteractive; apt-get -y update \
  &amp;&amp; apt-get install -y git-core \
    libcurl4-openssl-dev \
    libssl-dev \
    make \
    pandoc \
    pandoc-citeproc \
    zlib1g-dev
RUN ["install2.r", "rmarkdown"]

COPY ["./", "./"]
ENTRYPOINT ["Rscript", "server.R"]</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="deployment">Deployment<a class="anchor" aria-label="anchor" href="#deployment"></a>
</h2>
<p>Once all the files are in a folder, you can point the deployment
function at it to deploy it.</p>
<p>The deployment function will:</p>
<ul>
<li>Create a Docker container with your files via
<code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code>
</li>
<li>Deploy that Docker container to Cloud Run via
<code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code>
</li>
</ul>
<p>You can customise the steps by using the specific buildstep functions
directly.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">deploy_folder</span> <span class="op">&lt;-</span> <span class="st">"your-folder"</span>

<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span><span class="op">(</span><span class="va">deploy_folder</span><span class="op">)</span></code></pre></div>
<p>You may also want to set up a build trigger so when you commit code
it will update the deployed Cloud Run.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
