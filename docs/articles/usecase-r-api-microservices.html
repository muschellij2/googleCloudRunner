<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Run private R micro-services on Cloud Run • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Run private R micro-services on Cloud Run">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-google-analytics.html">Schedule Google Analytics User Deletion API</a>
    </li>
    <li>
      <a href="../articles/usecase-rmarkdown-cloudrun.html">On-demand parameterised R Markdown reports</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Run private R micro-services on Cloud Run</h1>
            
            <h4 data-toc-skip class="date">2022-03-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/HEAD/vignettes/usecase-r-api-microservices.Rmd" class="external-link"><code>vignettes/usecase-r-api-microservices.Rmd</code></a></small>
      <div class="hidden name"><code>usecase-r-api-microservices.Rmd</code></div>

    </div>

    
    
<p>Being able to trigger R code via public HTTP requests opens up lots
of possibilities using webhooks, API calls and so on. You can also make
use of private HTTP requests so that services running multiple languages
can also easily interface with one another using a concept called
micro-services.</p>
<p>The use case described below uses R code deployed to a private as a
strategy for running lots of parallel computation, taking advantage of
Cloud Run’s autoscaling features to turn up and down compute resources
as needed.</p>
<p>Hosting the computation behind a plumber API and hosted on Cloud Run,
you can control what data is worked on via URL parameters, and loop
calling the API.</p>
<p>The R computation behind plumber could call other services or compute
directly, although keep in mind the 60min timeout for Cloud Run API
responses.</p>
<div class="section level3">
<h3 id="creating-the-cloud-run-deployment">Creating the Cloud Run deployment<a class="anchor" aria-label="anchor" href="#creating-the-cloud-run-deployment"></a>
</h3>
<p>The demo API queries a BigQuery database and computes a forecast for
the time-series it gets back. The data is from the Covid public datasets
hosted on BigQuery.</p>
<p>The plumber script below has two endpoints:</p>
<ul>
<li>
<code>/</code> to test its running</li>
<li>
<code>/covid_traffic</code> which is fetched with parameters region
and industry to specify what times-series to fetch a forecast for.</li>
</ul>
<p>We will want these to be private (e.g. only authenticated calls)
since they contain potentially expensive BigQuery queries.</p>
<div class="section level4">
<h4 id="plumber-api-script">plumber API script<a class="anchor" aria-label="anchor" href="#plumber-api-script"></a>
</h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"PORT"</span><span class="op">)</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>PORT <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span>

<span class="co">#auth via BQ_AUTH_FILE environment argument</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://code.markedmondson.me/bigQueryR/" class="external-link">bigQueryR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/xts" class="external-link">xts</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.robjhyndman.com/forecast/" class="external-link">forecast</a></span><span class="op">)</span>

<span class="co">#' @get /</span>
<span class="co">#' @html</span>
<span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="st">"&lt;html&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/html&gt;"</span>
<span class="op">}</span>


<span class="co">#' @get /covid_traffic</span>
<span class="co">#' @param industry the industry to filter results down to e.g "Software"</span>
<span class="co">#' @param region the region to filter results down to e.g "Europe"</span>
<span class="kw">function</span><span class="op">(</span><span class="va">region</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">industry</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>

  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">industry</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Must supply region and industry parameters"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="co"># to handle spaces</span>
  <span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html" class="external-link">URLdecode</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>
  <span class="va">industry</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html" class="external-link">URLdecode</a></span><span class="op">(</span><span class="va">industry</span><span class="op">)</span>

  <span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"SELECT date, industry, percent_of_baseline FROM `bigquery-public-data.covid19_geotab_mobility_impact.commercial_traffic_by_industry`  WHERE region = '%s' order by date LIMIT 1000"</span>, <span class="va">region</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Query: "</span>, <span class="va">sql</span><span class="op">)</span>

  <span class="va">traffic</span> <span class="op">&lt;-</span> <span class="fu">bqr_query</span><span class="op">(</span>
    query <span class="op">=</span> <span class="va">sql</span>,
    datasetId <span class="op">=</span> <span class="st">"covid19_geotab_mobility_impact"</span>,
    useLegacySql <span class="op">=</span> <span class="cn">FALSE</span>,
    maxResults <span class="op">=</span> <span class="fl">10000</span>
  <span class="op">)</span>

  <span class="co"># filter to industry in R this time</span>
  <span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">traffic</span><span class="op">[</span><span class="va">traffic</span><span class="op">$</span><span class="va">industry</span> <span class="op">==</span> <span class="va">industry</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"percent_of_baseline"</span><span class="op">)</span><span class="op">]</span>

  <span class="va">tts</span> <span class="op">&lt;-</span> <span class="fu">xts</span><span class="op">(</span><span class="va">test_data</span><span class="op">$</span><span class="va">percent_of_baseline</span>,
             order.by <span class="op">=</span> <span class="va">test_data</span><span class="op">$</span><span class="va">date</span>,
             frequency <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>

  <span class="co"># replace with long running sophisticated analysis</span>
  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="op">(</span><span class="fu">auto.arima</span><span class="op">(</span><span class="va">tts</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># output a list that can be turned into JSON via jsonlite::toJSON</span>
  <span class="va">o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">industry</span><span class="op">)</span>,
    x <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">x</span>,
    mean <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">mean</span>,
    lower <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">lower</span>,
    upper <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">upper</span>
  <span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Return: "</span>, <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">o</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">o</span>

<span class="op">}</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="deploy-plumber-api-as-a-private-micro-service">Deploy plumber API as a private micro-service<a class="anchor" aria-label="anchor" href="#deploy-plumber-api-as-a-private-micro-service"></a>
</h4>
<p>The first step is to host the plumber API above.</p>
<p>The steps below:</p>
<ul>
<li>Download an authentication file for the script</li>
<li>Build the Docker container for the plumber API</li>
<li>Deploys the plumber API to a private Cloud Run instance</li>
<li>Creates the cloudbuild.yml and writes it to a file in the repo</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret</a></span><span class="op">(</span><span class="st">"my-auth"</span>,
      decrypted <span class="op">=</span> <span class="st">"inst/docker/parallel_cloudrun/plumber/auth.json"</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span><span class="op">(</span><span class="st">"cloudrun_parallel"</span>,
                      dir <span class="op">=</span> <span class="st">"inst/docker/parallel_cloudrun/plumber"</span>,
                      kaniko_cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span><span class="op">(</span><span class="st">"parallel-cloudrun"</span>,
                   image <span class="op">=</span> <span class="st">"gcr.io/$PROJECT_ID/cloudrun_parallel:$BUILD_ID"</span>,
                   allowUnauthenticated <span class="op">=</span> <span class="cn">FALSE</span>,
                   env_vars <span class="op">=</span> <span class="st">"BQ_AUTH_FILE=auth.json,BQ_DEFAULT_PROJECT_ID=$PROJECT_ID"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># make a buildtrigger pointing at above steps</span>
<span class="va">cloudbuild_file</span> <span class="op">&lt;-</span> <span class="st">"inst/docker/parallel_cloudrun/cloudbuild.yml"</span>
<span class="va">by</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span><span class="va">bs</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_build_write.html">cr_build_write</a></span><span class="op">(</span><span class="va">by</span>, file <span class="op">=</span> <span class="va">cloudbuild_file</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="create-a-build-trigger-so-it-builds-upon-each-git-commit">Create a build trigger so it builds upon each git commit<a class="anchor" aria-label="anchor" href="#create-a-build-trigger-so-it-builds-upon-each-git-commit"></a>
</h4>
<p>Now the cloudbuild.yml is available, a build trigger is created so
that it will deploy upon each commit to this GitHub:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span><span class="va">cloudbuild_file</span>,
                <span class="st">"parallel-cloudrun"</span>,
                trigger <span class="op">=</span> <span class="va">repo</span>,
                includedFiles <span class="op">=</span> <span class="st">"inst/docker/parallel_cloudrun/**"</span><span class="op">)</span></code></pre></div>
<p>The files are then committed to GitHub and the build reviewed in the
GCP Console.</p>
<p>Once the builds are done, you should have a plumber API deployed with
a URL similar to
<code>https://parallel-cloudrun-ewjogewawq-ew.a.run.app/</code></p>
</div>
</div>
<div class="section level3">
<h3 id="calling-the-private-plumber-api-with-a-jwt">Calling the private plumber API with a JWT<a class="anchor" aria-label="anchor" href="#calling-the-private-plumber-api-with-a-jwt"></a>
</h3>
<p>Now the plumber API is up, but to call it with authentication will
need a JSON Web Token, or JWT. These are supported via the
<code><a href="../reference/cr_jwt_create.html">cr_jwt_create()</a></code> functions:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_get.html">cr_run_get</a></span><span class="op">(</span><span class="st">"parallel-cloudrun"</span><span class="op">)</span>

<span class="co"># Interact with the authenticated Cloud Run service</span>
<span class="va">the_url</span> <span class="op">&lt;-</span> <span class="va">cr</span><span class="op">$</span><span class="va">status</span><span class="op">$</span><span class="va">url</span>
<span class="va">jwt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_create</a></span><span class="op">(</span><span class="va">the_url</span><span class="op">)</span>

<span class="co"># needs to be recreated every 60mins</span>
<span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_token</a></span><span class="op">(</span><span class="va">jwt</span>, <span class="va">the_url</span><span class="op">)</span>

<span class="co"># call Cloud Run with token using httr call</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/" class="external-link">httr</a></span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_with_httr</a></span><span class="op">(</span>
  <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="st">"https://parallel-cloudrun-ewjogewawq-ew.a.run.app/"</span><span class="op">)</span>,
  <span class="va">token</span><span class="op">)</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></code></pre></div>
<p>The JWT token needs renewing each hour.</p>
<div class="section level4">
<h4 id="use-your-private-micro-service">Use your private micro-service<a class="anchor" aria-label="anchor" href="#use-your-private-micro-service"></a>
</h4>
<p>The above shows you can call the API’s test endpoint, but now we wish
to call the API many times with the parameters to filter to the data we
want.</p>
<p>This is facilitated by a wrapper function to call our API:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># interact with the API we made</span>
<span class="va">call_api</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">region</span>, <span class="va">industry</span>, <span class="va">token</span><span class="op">)</span><span class="op">{</span>
  <span class="va">api</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span>
    <span class="st">"https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=%s&amp;industry=%s"</span>,
    <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html" class="external-link">URLencode</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html" class="external-link">URLencode</a></span><span class="op">(</span><span class="va">industry</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Request: "</span>, <span class="va">api</span><span class="op">)</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_with_httr</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">api</span><span class="op">)</span>,<span class="va">token</span><span class="op">)</span>

  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">res</span>, as <span class="op">=</span> <span class="st">"text"</span>, encoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span>

<span class="op">}</span>

<span class="co"># test call</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">call_api</span><span class="op">(</span>region <span class="op">=</span> <span class="st">"Europe"</span>, industry <span class="op">=</span> <span class="st">"Software"</span>, token <span class="op">=</span> <span class="va">token</span><span class="op">)</span></code></pre></div>
<p>Once the test call is complete, you can loop over your data - the
parameters for this particular dataset are shown below:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># the variables to loop over</span>
<span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"North America"</span>, <span class="st">"Europe"</span>,<span class="st">"South America"</span>,<span class="st">"Australia"</span><span class="op">)</span>
<span class="va">industry</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Transportation (non-freight)"</span>,
              <span class="st">"Software"</span>,
              <span class="st">"Telecommunications"</span>,
              <span class="st">"Manufacturing"</span>,
              <span class="st">"Real Estate"</span>,
              <span class="st">"Energy &amp; Utilities"</span>,
              <span class="st">"Education"</span>,
              <span class="st">"Insurance"</span>,
              <span class="st">"Media &amp; Internet"</span>,
              <span class="st">"Minerals &amp; Mining"</span>,
              <span class="st">"Healthcare Services &amp; Hospitals"</span>,
              <span class="st">"Organizations"</span>,
              <span class="st">"Finance"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="parallel-calling-of-the-api">Parallel calling of the API<a class="anchor" aria-label="anchor" href="#parallel-calling-of-the-api"></a>
</h4>
<p>For parallel processing, ideally you don’t want R to block waiting
for the HTTP response for each URL you are sending. This is easiest
achieved through using <a href="https://jeroen.cran.dev/curl" class="external-link"><code>curl</code></a> and its <a href="https://cran.r-project.org/web/packages/curl/vignettes/intro.html#async_requests" class="external-link"><code>curl_fetch_multi()</code></a>
function.</p>
<p>A helper function that takes care of adding multiple URLs to the same
curl pool is <code><a href="../reference/cr_jwt_create.html">cr_jwt_with_curl()</a></code> - if you pass it a vector
of URL strings to call and the token, it will attempt to call all of
them at the same time.</p>
<p>An example calling each possible combination of the
industries/regions above is shown below, which utilises
<code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code> to create the URL variations.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## curl multi asynch</span>

<span class="co"># function to make the URLs</span>
<span class="va">make_urls</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">regions</span>, <span class="va">industry</span><span class="op">)</span><span class="op">{</span>

  <span class="va">combos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="va">regions</span>, <span class="va">industry</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=%s&amp;industry=%s"</span>,<span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html" class="external-link">URLencode</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html" class="external-link">URLencode</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>,
                SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span>, USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span>,
         <span class="va">combos</span><span class="op">$</span><span class="va">Var1</span> ,<span class="va">combos</span><span class="op">$</span><span class="va">Var2</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># make all the URLs</span>
<span class="va">all_urls</span> <span class="op">&lt;-</span> <span class="fu">make_urls</span><span class="op">(</span>regions <span class="op">=</span> <span class="va">regions</span>, industry <span class="op">=</span> <span class="va">industry</span><span class="op">)</span>

<span class="co"># calling them</span>
<span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_async</a></span><span class="op">(</span><span class="va">all_urls</span>, token <span class="op">=</span> <span class="va">token</span><span class="op">)</span></code></pre></div>
<p>Some example output is shown below - note that some combinations
didn’t have data so the API returned a 500 error, but later valid
combinations completed and returned the JSON response for the
forecast:</p>
<pre><code>&gt; # calling them
&gt; cr_jwt_async(all_urls, token = token)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=North%20America&amp;industry=Transportation%20(non-freight)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=Europe&amp;industry=Transportation%20(non-freight)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=South%20America&amp;industry=Transportation%20(non-freight)
ℹ 2020-09-20 21:58:13 &gt; 500 failure for request https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=North%20America&amp;industry=Software
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=Australia&amp;industry=Transportation%20(non-freight)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=North%20America&amp;industry=Software
[[1]]
[1] "{\"params\":[\"North America\",\"Transportation (non-freight)\"],\"x\":[100,99,108,104,105,104,105,102,102,108,104,105,104,105,99,98,59,78,78,78,78,100,100,108,106,105,105,105,100,103,109,104,104,105,106,103,102,108,104,104,103,100,96,97,67,64,62,60,59],\"mean\":[64.031,68.3173,71.9691,75.0803,77.731,79.9894,81.9135,83.5527,84.9493,86.1392],\"lower\":[[52.8354,46.9089],[53.6094,45.8236],[55.1655,46.2703],[56.9063,47.2856],[58.6237,48.5089],[60.2322,49.7734],[61.6977,50.9961],[63.0104,52.136],[64.1733,53.1751],[65.1951,54.108]],\"upper\":[[75.2265,81.1531],[83.0251,90.8109],[88.7726,97.6679],[93.2543,102.8751],[96.8384,106.9531],[99.7466,110.2054],[102.1292,112.8308],[104.095,114.9694],[105.7254,116.7235],[107.0833,118.1704]]}"

[[2]]
[1] "{\"params\":[\"South America\",\"Transportation (non-freight)\"],\"x\":[14,13,12,9,13,17,19,15,11,14,15,16,16,14,11,15,19,18,16,16,12,18,21,18,18,12,18,19,18,19,16,15,17,20,21,20,18,24,26,25,18,22,19,17,21,24,20,19,19,23,27,27,24,22,17,24,26,24,20,18,21,24,23,20,26,19,20,17,21,26,23,19,17,27,23,20,21,22,17,26,23,20,18,21,19,18,28,22,18,24,15,21,27,21,21],\"mean\":[19.7145,21.4333,23.6604,24.1475,22.5433,20.6944,20.6384,22.468,24.3021,24.3207],\"lower\":[[15.9943,14.0249],[17.6591,15.6611],[19.8826,17.8828],[20.3669,18.3656],[18.7179,16.6929],[16.7392,14.6454],[16.566,14.4103],[18.3612,16.1872],[20.1922,18.0166],[20.2036,18.0241]],\"upper\":[[23.4346,25.404],[25.2075,27.2054],[27.4381,29.438],[27.928,29.9293],[26.3686,28.3936],[24.6495,26.7433],[24.7107,26.8665],[26.5747,28.7487],[28.412,30.5876],[28.4378,30.6173]]}"

[[3]]
[1] "{\"params\":[\"Europe\",\"Transportation (non-freight)\"],\"x\":[40,52,55,50,52,44,59,55,54,60,63,43,54,49,46,38,64,55,53,51,58,61,42,43,40,54,53,60,63,54,44,43,52,38,53,51,47,53,58,44,54,62,56,59,63,48,62,66,60,68,73,69,71,77,77,63,66],\"mean\":[68.5688,68.5688,68.5688,68.5688,68.5688,68.5688,68.5688,68.5688,68.5688,68.5688],\"lower\":[[58.5753,53.2851],[58.1036,52.5637],[57.6523,51.8735],[57.2189,51.2107],[56.8015,50.5723],[56.3984,49.9558],[56.0082,49.359],[55.6297,48.7802],[55.2621,48.2179],[54.9043,47.6707]],\"upper\":[[78.5622,83.8525],[79.0339,84.5738],[79.4852,85.2641],[79.9186,85.9269],[80.3361,86.5653],[80.7392,87.1818],[81.1294,87.7786],[81.5078,88.3573],[81.8755,88.9196],[82.2333,89.4668]]}"</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
