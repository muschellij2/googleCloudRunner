<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scheduled R scripts via Cloud Scheduler • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Scheduled R scripts via Cloud Scheduler">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-google-analytics.html">Schedule Google Analytics User Deletion API</a>
    </li>
    <li>
      <a href="../articles/usecase-rmarkdown-cloudrun.html">On-demand parameterised R Markdown reports</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Scheduled R scripts via Cloud Scheduler</h1>
            
            <h4 data-toc-skip class="date">2022-03-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/HEAD/vignettes/cloudscheduler.Rmd" class="external-link"><code>vignettes/cloudscheduler.Rmd</code></a></small>
      <div class="hidden name"><code>cloudscheduler.Rmd</code></div>

    </div>

    
    
<p><a href="https://cloud.google.com/scheduler/" class="external-link">Cloud Scheduler</a> is
a scheduler service in the Google Cloud that uses cron like syntax to
schedule tasks. It can trigger HTTP or Pub/Sub jobs via
<code><a href="../reference/cr_schedule.html">cr_schedule()</a></code></p>
<p><code>googleCloudRunner</code> uses Cloud Scheduler to help schedule
Cloud Builds but Cloud Scheduler can schedule HTTP requests to any
endpoint:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">cr_scheduler</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"my-webhook"</span>, <span class="st">"14 5 * * *"</span>, 
             httpTarget <span class="op">=</span> <span class="fu"><a href="../reference/HttpTarget.html">HttpTarget</a></span><span class="op">(</span>httpMethod<span class="op">=</span><span class="st">"GET"</span>, uri <span class="op">=</span> <span class="st">"https://mywebhook.com"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>How scheduling works with various functions in
<code>googleCloudRunner</code> is shown in the below plot for an
overview:</p>
<p><img src="schedule_plot.png"></p>
<div class="section level2">
<h2 id="schedule-cloud-build">Schedule Cloud Build<a class="anchor" aria-label="anchor" href="#schedule-cloud-build"></a>
</h2>
<p>Since Cloud Build can run any code in a container, scheduling them
becomes a powerful way to setup batched data flows.</p>
<p>A demo below shows how to set up a Cloud Build on a schedule from
R:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">build1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="st">"cloudbuild.yaml"</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"15 5 * * *"</span>, name<span class="op">=</span><span class="st">"cloud-build-test1"</span>,
             httpTarget <span class="op">=</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_http</a></span><span class="op">(</span><span class="va">build1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We use <code><a href="../reference/cr_build_make.html">cr_build_make()</a></code> and
<code><a href="../reference/cr_schedule.html">cr_schedule_http()</a></code> to create the Cloud Build API request,
and then send that to the Cloud Scheduler API via its
<code>httpTarget</code> parameter.</p>
<p>Update a schedule by specifying the same name and the
<code>overwrite=TRUE</code> flag. You need then need to supply what you
want to change, everything else will remain as previously
configured.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"my-webhook"</span>, <span class="st">"12 6 * * *"</span>, overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="schedule-builds-triggers-using-pubsub">Schedule Builds Triggers using PubSub<a class="anchor" aria-label="anchor" href="#schedule-builds-triggers-using-pubsub"></a>
</h2>
<p><code><a href="../reference/cr_schedule.html">cr_schedule_http()</a></code> works by creating an API call that
will trigger a Cloud Build from the Cloud Scheduler service, but this
can be harder to set-up from an authentication standpoint and also give
unhelpful errors that are hard to debug.</p>
<p>For more robust and transparent scheduling of builds it is recommend
you use PubSub to trigger builds via a build trigger that has been
set-up to respond to Pub/Sub messages. This holds additional advantages
such as being able to accept PubSub messages from other sources to
trigger your builds, and being able to parametrise your builds using the
content within the PubSub message data.</p>
<p>The general strategy is:</p>
<ol style="list-style-type: decimal">
<li>Create and test your build locally using
<code><a href="../reference/cr_build.html">cr_build()</a></code>
</li>
<li>Create a PubSub topic either in the Google Cloud console or using
<code><a href="https://github.com/andodet/googlePubsubR" class="external-link">library(googlePubsubR)</a></code>
</li>
<li>Create a build trigger for your build using
<code><a href="../reference/cr_buildtrigger.html">cr_buildtrigger()</a></code> with a topic set using
<code><a href="../reference/cr_buildtrigger_pubsub.html">cr_buildtrigger_pubsub()</a></code>
</li>
<li>Schedule pushes to the PubSub topic using
<code><a href="../reference/cr_schedule.html">cr_schedule_pubsub()</a></code>. You can choose to set up schedules
with parameters that are passed into the Builds.</li>
</ol>
<p>An example is given below:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cloudbuild</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"cloudbuild/cloudbuild.yml"</span>,
                        package <span class="op">=</span> <span class="st">"googleCloudRunner"</span><span class="op">)</span>
<span class="va">bb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="va">cloudbuild</span><span class="op">)</span>

<span class="co"># create a pubsub topic either in Google Console webUI or library(googlePubSubR)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/andodet/googlePubsubR" class="external-link">googlePubsubR</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/googlePubsubR/man/pubsub_auth.html" class="external-link">pubsub_auth</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/googlePubsubR/man/topics_create.html" class="external-link">topics_create</a></span><span class="op">(</span><span class="st">"test-topic"</span><span class="op">)</span>

<span class="co"># create build trigger that will watch for messages to your created topic</span>
<span class="va">pubsub_trigger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_pubsub.html">cr_buildtrigger_pubsub</a></span><span class="op">(</span><span class="st">"test-topic"</span><span class="op">)</span>

<span class="co"># create the build trigger with in-line build</span>
<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span><span class="va">bb</span>, name <span class="op">=</span> <span class="st">"pubsub-triggered"</span>, trigger <span class="op">=</span> <span class="va">pubsub_trigger</span><span class="op">)</span>

<span class="co"># create scheduler that calls the pub/sub topic</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"cloud-build-pubsub"</span>,
            <span class="st">"15 5 * * *"</span>,
            pubsubTarget <span class="op">=</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_pubsub</a></span><span class="op">(</span><span class="st">"test-topic"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Builds can be also parametrised to respond to parameters within your
PubSub topic. The cloudbuild below echo back the value sent in
<code>var1</code> of the PubSub message, and the scheduler is set-up to
send in parameters.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cloudbuild</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"cloudbuild/cloudbuild_substitutions.yml"</span>,
                           package <span class="op">=</span> <span class="st">"googleCloudRunner"</span><span class="op">)</span>
<span class="va">the_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="va">cloudbuild</span><span class="op">)</span>

<span class="co"># var1 is sent via Pubsub to the buildtrigger</span>
<span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>var1 <span class="op">=</span> <span class="st">"hello mum"</span><span class="op">)</span>
<span class="va">send_me</span> <span class="op">&lt;-</span> <span class="fu">googlePubsubR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/googlePubsubR/man/msg_encode.html" class="external-link">msg_encode</a></span><span class="op">(</span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">message</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create build trigger that will work from pub/subscription</span>
<span class="va">pubsub_trigger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_pubsub.html">cr_buildtrigger_pubsub</a></span><span class="op">(</span><span class="st">"test-topic"</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span><span class="va">the_build</span>, name <span class="op">=</span> <span class="st">"pubsub-triggered-subs"</span>, trigger <span class="op">=</span> <span class="va">pubsub_trigger</span><span class="op">)</span>

<span class="co"># create scheduler that calls the pub/sub topic with a parameter</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"cloud-build-pubsub-params"</span>,
            <span class="st">"15 5 * * *"</span>,
            pubsubTarget <span class="op">=</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_pubsub</a></span><span class="op">(</span><span class="st">"test-topic"</span>,
                                              data <span class="op">=</span> <span class="va">send_me</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This opens up a lot of possibilities of when and where your code can
run in reaction to both events (git commits, files hitting cloud
storage, generic events on GCP) and on a schedule.</p>
</div>
<div class="section level2">
<h2 id="schedule-cloud-run-applications">Schedule Cloud Run applications<a class="anchor" aria-label="anchor" href="#schedule-cloud-run-applications"></a>
</h2>
<div class="section level3">
<h3 id="public-http-endpoints">Public HTTP endpoints<a class="anchor" aria-label="anchor" href="#public-http-endpoints"></a>
</h3>
<p>Via Cloud Scheduler you can set up a scheduled hit of your HTTP
endpoints, via GET, POST or any other methods you have coded into your
app. <code><a href="../reference/cr_run_schedule_http.html">cr_run_schedule_http()</a></code> will help you create the HTTP
endpoint for you to pass to <code><a href="../reference/cr_schedule.html">cr_schedule()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">run_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_schedule_http.html">cr_run_schedule_http</a></span><span class="op">(</span>
       <span class="st">"https://example-ewjogewawq-ew.a.run.app/echo?msg=blah"</span>,
      http_method <span class="op">=</span> <span class="st">"GET"</span>
     <span class="op">)</span>

<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"cloud-run-scheduled"</span>, schedule <span class="op">=</span> <span class="st">"4 16 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">run_me</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="private-http-endpoints">Private HTTP endpoints<a class="anchor" aria-label="anchor" href="#private-http-endpoints"></a>
</h3>
<p>When you create an app via
<code>cr_deploy_run("my-app", allowUnauthenticated = FALSE)</code> a new
service account will be created with the rights called “my-app-invoker”.
Use that email to tell the scheduler how to call the app:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for authenticated Cloud Run apps - create with allowUnauthenticated=FALSE</span>
<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_run</a></span><span class="op">(</span><span class="st">"my-app"</span>, allowUnauthenticated <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># deploying via R will help create a service email called my-app-invoker</span>
<span class="fu"><a href="../reference/cr_run_email.html">cr_run_email</a></span><span class="op">(</span><span class="st">"my-app"</span><span class="op">)</span>
<span class="co">#&gt; "my-app-invoker@your-project.iam.gserviceaccount.com"</span>

<span class="co"># schedule the endpoint</span>
<span class="va">my_app</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_get.html">cr_run_get</a></span><span class="op">(</span><span class="st">"my-app"</span><span class="op">)</span>

<span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_app</span><span class="op">$</span><span class="va">status</span><span class="op">$</span><span class="va">url</span>, <span class="st">"/fetch_stuff"</span><span class="op">)</span>

<span class="va">app_sched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_schedule_http.html">cr_run_schedule_http</a></span><span class="op">(</span><span class="va">endpoint</span>,
                                  http_method <span class="op">=</span> <span class="st">"GET"</span>,
                                  email <span class="op">=</span> <span class="fu"><a href="../reference/cr_run_email.html">cr_run_email</a></span><span class="op">(</span><span class="st">"my-app"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"my-app-scheduled-1"</span>,
            schedule <span class="op">=</span> <span class="st">"16 4 * * *"</span>,
            httpTarget <span class="op">=</span> <span class="va">app_sched</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="schedule-an-r-script">Schedule an R script<a class="anchor" aria-label="anchor" href="#schedule-an-r-script"></a>
</h2>
<p>A common use case is scheduling an R script. This is provided by
<code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code></p>
<p>A minimal example is:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create an r script that will echo the time</span>
<span class="va">the_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span><span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span><span class="st">"cat(Sys.time())"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># construct a Cloud Build API call to call that build</span>
<span class="va">build_call</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_http</a></span><span class="op">(</span><span class="va">the_build</span><span class="op">)</span>

<span class="co"># schedule the API call for every minute</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"test1"</span>, <span class="st">"* * * * *"</span>, httpTarget <span class="op">=</span> <span class="va">build_call</span><span class="op">)</span>

<span class="co"># you should return a scheduler object</span>
<span class="va">test_schedule</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_schedule_get.html">cr_schedule_get</a></span><span class="op">(</span><span class="st">"test1"</span><span class="op">)</span>

<span class="co"># once finished, delete the schedule</span>
<span class="fu"><a href="../reference/cr_schedule_delete.html">cr_schedule_delete</a></span><span class="op">(</span><span class="st">"test1"</span><span class="op">)</span></code></pre></div>
<p>After it triggers you should see a “SUCCESS” in the <a href="https://console.cloud.google.com/cloudscheduler" class="external-link">Cloud Scheduler
console</a> and associated builds in the <a href="https://console.cloud.google.com/cloud-build/builds" class="external-link">Cloud Build
web UI</a>.</p>
<p>The above assumes you have followed the recommended authentication
setup using <code><a href="../reference/cr_setup.html">cr_setup()</a></code> and <code><a href="../reference/cr_setup_test.html">cr_setup_test()</a></code> all
work.</p>
<p>In particular you can check the email that the API call will run
under on Cloud Scheduler in
<code>test_schedule$httpTarget$oauthToken$serviceAccountEmail</code></p>
<div class="section level3">
<h3 id="a-more-complicated-r-script-example">A more complicated R script example<a class="anchor" aria-label="anchor" href="#a-more-complicated-r-script-example"></a>
</h3>
<p>This example shows running R scripts across a source such as GitHub
or Cloud Respositories. This is used for builds such as package checks
and website builds. This uses the helper deployment function,
<code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code> which is also available as an RStudio
gadget.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># this can be an R filepath or lines of R read in from a script</span>
<span class="va">r_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"list.files()"</span>,
              <span class="st">"library(dplyr)"</span>,
              <span class="st">"mtcars %&gt;% select(mpg)"</span>,
              <span class="st">"sessionInfo()"</span><span class="op">)</span>

<span class="co"># example code runs against a source that is a mirrored GitHub repo</span>
<span class="va">source</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_source.html">cr_build_source</a></span><span class="op">(</span><span class="fu"><a href="../reference/RepoSource.html">RepoSource</a></span><span class="op">(</span><span class="st">"googleCloudStorageR"</span>,
                                      branchName <span class="op">=</span> <span class="st">"master"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># check the script runs ok</span>
<span class="fu"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span><span class="op">(</span><span class="va">r_lines</span>, source <span class="op">=</span> <span class="va">source</span><span class="op">)</span>

<span class="co"># schedule the script once its working</span>
<span class="fu"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span><span class="op">(</span><span class="va">r_lines</span>, schedule <span class="op">=</span> <span class="st">"15 21 * * *"</span>, source <span class="op">=</span> <span class="va">source</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="supplying-your-own-docker-image">Supplying your own Docker image<a class="anchor" aria-label="anchor" href="#supplying-your-own-docker-image"></a>
</h3>
<p>The examples above are all using the default of
<code>rocker/r-base</code> for the R environment. If you have package
dependencies for your script you would need to install them within the
script.</p>
<p>An alternative is to customise the Docker image so it includes the R
packages you need. For instance, <code>rocker/tidyverse</code> would
load the Tidyverse packages.</p>
<p>You may also want to customise the R docker image further - in this
case you can build your docker image first with your R libraries
installed, then specify that image in your R deployment.</p>
<p>Once you have your R Docker file, supply it to
<code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code> via its <code>r_image</code> argument.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span><span class="op">(</span><span class="st">"my_folder_with_dockerfile"</span>, 
                 image_name <span class="op">=</span> <span class="st">"gcr.io/my-project/my-image"</span>,
                 tag <span class="op">=</span> <span class="st">"dev"</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span><span class="op">(</span><span class="va">r_lines</span>, 
            schedule <span class="op">=</span> <span class="st">"15 21 * * *"</span>, 
            source <span class="op">=</span> <span class="va">source</span>,
            r_image <span class="op">=</span> <span class="st">"gcr.io/my-project/my-image:dev"</span><span class="op">)</span></code></pre></div>
<p>The logs of the scheduled scripts are in the history section of Cloud
Build - each scheduled run is creating a new Cloud Build.</p>
</div>
<div class="section level3">
<h3 id="rstudio-gadget---schedule-r-scripts">RStudio Gadget - schedule R scripts<a class="anchor" aria-label="anchor" href="#rstudio-gadget---schedule-r-scripts"></a>
</h3>
<p>If you are using RStudio, installing the library will enable an <a href="https://rstudio.github.io/rstudioaddins/" class="external-link">RStudio Addin</a> that
can be called after you have setup the library as per the setup
page.</p>
<p>It includes a Shiny gadget that you can call via the Addin menu in
RStudio, via <code><a href="../reference/cr_deploy_gadget.html">googleCloudRunner::cr_deploy_gadget()</a></code> or
assigned to a hotkey (I use CTRL+SHIFT+D).</p>
<p>This sets up a Shiny UI to help smooth out deployments as
pictured:</p>
<p><img src="gadget_r.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="build-and-schedule-an-r-script-custom">Build and schedule an R script (custom)<a class="anchor" aria-label="anchor" href="#build-and-schedule-an-r-script-custom"></a>
</h2>
<p>If you want to customise deployments, then the steps covered by
<code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code> are covered below.</p>
<p>To schedule an R script the steps are:</p>
<ol style="list-style-type: decimal">
<li>Create your R script</li>
<li>Select or build an R enabled Dockerfile to run the R code</li>
<li>[optional] Build the R image</li>
<li>Select a source location that the R code will run upon</li>
<li>Schedule calling the Docker image using Cloud Scheduler</li>
</ol>
<div class="section level3">
<h3 id="create-your-r-script">1. Create your R script<a class="anchor" aria-label="anchor" href="#create-your-r-script"></a>
</h3>
<p>The R script can hold anything, but make sure its is self contained
with auth files, data files etc. All paths should be relative to the
script and available in the source you choose to build with (e.g. GCS or
git repo) or within the Docker image executing R.</p>
<p>Uploading auth files within Dockerfiles is not recommended security
wise. The recommend way to download auth files is to use Secret Manager,
which is available as a build step macro via
<code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code></p>
</div>
<div class="section level3">
<h3 id="bundle-the-r-script-with-a-dockerfile">2. Bundle the R script with a Dockerfile<a class="anchor" aria-label="anchor" href="#bundle-the-r-script-with-a-dockerfile"></a>
</h3>
<p>You may only need vanilla r or tidyverse, in which case select the
presets “rocker/r-ver” or “rocker/verse”.</p>
<p>You can also create your own Docker image - point it at the folder
with your script and a Dockerfile (perhaps created with
<code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code>)</p>
</div>
<div class="section level3">
<h3 id="build-the-docker-image-on-cloud-build">3. Build the Docker image on Cloud Build<a class="anchor" aria-label="anchor" href="#build-the-docker-image-on-cloud-build"></a>
</h3>
<p>Once you have your R script and Dockerfile in the same folder, you
need to build the image.</p>
<p>This can be automated via the <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code>
function supplying the folder containing the Dockerfile:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span><span class="op">(</span><span class="st">"my-scripts/"</span>, <span class="st">"gcr.io/your-project/your-name"</span><span class="op">)</span></code></pre></div>
<p>Once the image is built successfully, you do not need to build it
again for the scheduled calls - you could setup doing that only if the R
code changes.</p>
</div>
<div class="section level3">
<h3 id="make-the-build-and-optional-source">4. Make the build and optional source<a class="anchor" aria-label="anchor" href="#make-the-build-and-optional-source"></a>
</h3>
<p>You may want your R code to operate on data in Google Cloud Storage
or a git repo. Specify that source in your build, then make the build
object:</p>
<div class="section level4">
<h4 id="github-source">GitHub Source<a class="anchor" aria-label="anchor" href="#github-source"></a>
</h4>
<p>New from version 0.5 you can run schedules via triggered build
triggers. If using build triggers then you can specify the source in the
build trigger itself rather than within the build. This is a bit more
flexible since you can then simply commit to the GitHub repo to change
the running code and/or data for the next time the schedule runs.</p>
<p>Assuming you have a scheduled pubsub setup then you configure the
buildtrigger to run each time that pubsub is called like the example
below:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_pubsub</a></span><span class="op">(</span><span class="va">topic</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"target_pubsub_schedule"</span>, 
            schedule <span class="op">=</span> <span class="st">"15 4 * * *"</span>, 
            pubsubTarget <span class="op">=</span> <span class="va">schedule_me</span><span class="op">)</span>
            
<span class="co"># no regex allowed for sourceToBuild repo objects</span>
<span class="va">gh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span>, branch <span class="op">=</span> <span class="st">"master"</span><span class="op">)</span>

<span class="va">pubsub_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_pubsub.html">cr_buildtrigger_pubsub</a></span><span class="op">(</span><span class="va">topic</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span><span class="st">"cloudbuild_targets.yaml"</span>,
                name <span class="op">=</span> <span class="st">"targets-scheduled-demo"</span>,
                sourceToBuild <span class="op">=</span> <span class="va">gh</span>,
                trigger <span class="op">=</span> <span class="va">pubsub_sub</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="alternate-code-sources">Alternate code sources<a class="anchor" aria-label="anchor" href="#alternate-code-sources"></a>
</h3>
<p>There are also some other legacy ways to include code/data sources
within your builds, which you may still want to do if you are not
scheduling a build trigger but a build directly using
<code><a href="../reference/cr_schedule.html">cr_schedule_http()</a></code>. It is recommended though to use the
PubSub topics for easier debugging and transparency.</p>
<div class="section level4">
<h4 id="repo-source">Repo Source<a class="anchor" aria-label="anchor" href="#repo-source"></a>
</h4>
<p>This is if you have your code files within Cloud Source repositories
- this can include mirrors from other git providers such as GitHub - see
<a href="https://code.markedmondson.me/googleCloudRunner/articles/git.html">setting
up git</a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span><span class="st">"your-r-image"</span>, 
                       <span class="st">"R -e my_r_script.R"</span>,
                       prefix<span class="op">=</span><span class="st">"gcr.io/your-project"</span><span class="op">)</span>
                      <span class="op">)</span>
                         
<span class="co"># maybe you want a repo source</span>
<span class="va">repo_source</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_source.html">cr_build_source</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/RepoSource.html">RepoSource</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span>,
             branchName<span class="op">=</span><span class="st">"master"</span><span class="op">)</span><span class="op">)</span>
             
<span class="va">my_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="va">schedule_me</span>, source <span class="op">=</span> <span class="va">repo_source</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="cloud-storage-source">Cloud Storage Source<a class="anchor" aria-label="anchor" href="#cloud-storage-source"></a>
</h4>
<p>This keeps your R code source in a Cloud Storage bucket.</p>
<p>The first method uses <code><a href="../reference/cr_build_upload_gcs.html">?cr_build_upload_gcs</a></code> to create a
tar.gz that has zipped files in a folder that you upload:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span><span class="st">"your-r-image"</span>, 
                       <span class="st">"R -e my_r_script.R"</span>,
                        prefix<span class="op">=</span><span class="st">"gcr.io/your-project"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># upload a tar.gz of the files to use as a source:</span>
<span class="va">gcs_source</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_upload_gcs.html">cr_build_upload_gcs</a></span><span class="op">(</span><span class="st">"local_folder_with_r_script"</span><span class="op">)</span>
<span class="va">my_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="va">schedule_me</span>, source <span class="op">=</span> <span class="va">gcs_source</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="download-files-in-an-initial-buildstep">Download files in an initial buildstep<a class="anchor" aria-label="anchor" href="#download-files-in-an-initial-buildstep"></a>
</h4>
<p>When only a few files, it may be easiest to include downloading the R
file from your bucket first into the /workspace/ via a buildstep using
<a href="https://cloud.google.com/storage/docs/gsutil" class="external-link">gsutil</a>, not
using source at all:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"download R file"</span>,
      name <span class="op">=</span> <span class="st">"gsutil"</span>,
      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cp"</span>,
               <span class="st">"gs://mark-edmondson-public-read/my_r_script.R"</span>,
               <span class="st">"/workspace/my_r_script.R"</span><span class="op">)</span>
    <span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span><span class="st">"your-r-image"</span>, 
                 <span class="st">"R -e /workspace/my_r_script.R"</span>,
                 prefix<span class="op">=</span><span class="st">"gcr.io/your-project"</span><span class="op">)</span>
            <span class="op">)</span>
    <span class="op">)</span>

<span class="va">my_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="va">schedule_me</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="download-files-via-git">Download files via git<a class="anchor" aria-label="anchor" href="#download-files-via-git"></a>
</h4>
<p>Another alternative is to use git within the buildsteps to clone from
a repo - these can be private git repos if you have uploaded your git
SSH key to Secret Manager:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
      steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
           <span class="fu"><a href="../reference/cr_buildstep_git.html">cr_buildstep_gitsetup</a></span><span class="op">(</span><span class="st">"github-ssh"</span><span class="op">)</span>,
           <span class="fu"><a href="../reference/cr_buildstep_git.html">cr_buildstep_git</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"clone"</span>,
                              <span class="st">"git@github.com:github_name/repo_name"</span><span class="op">)</span><span class="op">)</span>,
           <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span><span class="st">"list.files()"</span><span class="op">)</span>
      <span class="op">)</span>
  <span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="schedule-calling-the-docker-image-using-cloud-scheduler">Schedule calling the Docker image using Cloud Scheduler<a class="anchor" aria-label="anchor" href="#schedule-calling-the-docker-image-using-cloud-scheduler"></a>
</h4>
<p>Once you have a working build, schedule that build object by passing
it to the <code><a href="../reference/cr_schedule.html">cr_schedule_http()</a></code> function, which constructs the
Cloud Build API call for Cloud Scheduler to call at its scheduled
times.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create a scheduler http endpoint that will trigger your build</span>
<span class="va">cloud_build_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_schedule.html">cr_schedule_http</a></span><span class="op">(</span><span class="va">my_build</span><span class="op">)</span>

<span class="co"># schedule it</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"15 5 * * *"</span>, name<span class="op">=</span><span class="st">"scheduled_r"</span>,
             httpTarget <span class="op">=</span> <span class="va">cloud_build_target</span><span class="op">)</span></code></pre></div>
<p>You can automate updates to the script and/or Docker container or
schedule separately, by redoing the relevant step above, or using
<code><a href="../reference/cr_buildtrigger.html">cr_buildtrigger()</a></code> to automate deployments.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
